<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비밀번호 재설정 - THE동문회</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: rgba(0, 0, 0, 0.5);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-container {
            background: white;
            border-radius: 24px;
            max-width: 480px;
            width: 100%;
            max-height: 80%;
            margin-bottom: 100px;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #3b3c36;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 18px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .close-button:hover {
            color: #374151;
        }
        
        .modal-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
        }
        
        .input-wrapper.valid {
            border-color: #10b981;
        }
        
        .input-wrapper.invalid {
            border-color: #ef4444;
        }
        
        .form-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 16px;
            border: none;
            outline: none;
            background: transparent;
            color: #111827;
        }
        
        .form-input::placeholder {
            color: #9ca3af;
        }
        
        
        .toggle-password {
            background: none;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggle-password:hover {
            color: #6b7280;
        }
        
        .password-requirements {
            margin-top: 8px;
            margin-left: 4px;
        }
        
        .requirement-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .requirement-icon {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            flex-shrink: 0;
        }
        
        .requirement-icon.valid {
            color: #10b981;
        }
        
        .requirement-icon.invalid {
            color: #9ca3af;
        }
        
        .requirement-text {
            color: #6b7280;
        }
        
        .requirement-text.valid {
            color: #10b981;
        }
        
        .requirement-text.invalid {
            color: #6b7280;
        }
        
        .password-match {
            margin-top: 4px;
            margin-left: 4px;
            font-size: 12px;
        }
        
        .password-match.valid {
            color: #10b981;
        }
        
        .password-match.invalid {
            color: #ef4444;
        }
        
        .submit-button {
            width: 100%;
            background: #3b3c36;
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 24px;
        }
        
        .submit-button:hover:not(:disabled) {
            background: #2a2b26;
        }
        
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 24px;
            color: #6b7280;
        }
        
        .loading.active {
            display: block;
        }
        
        .error {
            display: none;
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
        }
        
        .error.active {
            display: block;
        }
        
        .success {
            display: none;
            background: #d1fae5;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
        }
        
        .success.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="modal-container">
        <!-- 헤더 -->
        <div class="modal-header">
            <div class="modal-title">비밀번호 변경</div>
            <button type="button" class="close-button" onclick="window.close()">✕</button>
        </div>
        
        <!-- 스크롤 가능한 내용 -->
        <div class="modal-content">
            <form id="resetForm" onsubmit="handleResetPassword(event)">
                <!-- 이메일 -->
                <div class="form-group">
                    <label class="form-label" for="userEmail">이메일</label>
                    <div class="input-wrapper">
                        <input
                            type="email"
                            id="userEmail"
                            class="form-input"
                            placeholder="이메일을 입력하세요"
                            required
                        />
                    </div>
                </div>
                
                <!-- 새 비밀번호 -->
                <div class="form-group">
                    <label class="form-label" for="newPassword">Password</label>
                    <div class="input-wrapper">
                        <input
                            type="password"
                            id="newPassword"
                            class="form-input"
                            placeholder="Enter your password"
                            autocomplete="new-password"
                        />
                        <button type="button" class="toggle-password" onclick="togglePassword('newPassword', 'toggleNewPassword')">
                            <svg id="toggleNewPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <!-- 비밀번호 조건 표시 -->
                    <div class="password-requirements" id="passwordRequirements" style="display: none;">
                        <div class="requirement-item">
                            <svg class="requirement-icon invalid" id="reqMinLength" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            <span class="requirement-text invalid" id="reqMinLengthText">8자 이상</span>
                        </div>
                        <div class="requirement-item">
                            <svg class="requirement-icon invalid" id="reqUpperCase" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            <span class="requirement-text invalid" id="reqUpperCaseText">대문자 포함</span>
                        </div>
                        <div class="requirement-item">
                            <svg class="requirement-icon invalid" id="reqLowerCase" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            <span class="requirement-text invalid" id="reqLowerCaseText">소문자 포함</span>
                        </div>
                        <div class="requirement-item">
                            <svg class="requirement-icon invalid" id="reqNumber" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            <span class="requirement-text invalid" id="reqNumberText">숫자 포함</span>
                        </div>
                        <div class="requirement-item">
                            <svg class="requirement-icon invalid" id="reqSpecialChar" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                            <span class="requirement-text invalid" id="reqSpecialCharText">특수문자 포함 (!@#$%^&* 등)</span>
                        </div>
                    </div>
                </div>
                
                <!-- 비밀번호 확인 -->
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm Password</label>
                    <div class="input-wrapper" id="confirmPasswordWrapper">
                        <input
                            type="password"
                            id="confirmPassword"
                            class="form-input"
                            placeholder="Confirm your password"
                            autocomplete="new-password"
                        />
                        <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword', 'toggleConfirmPassword')">
                            <svg id="toggleConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                    <div class="password-match invalid" id="passwordMatch" style="display: none;">
                        비밀번호가 일치하지 않습니다.
                    </div>
                </div>
                
                <button type="submit" class="submit-button" id="submitBtn">
                    비밀번호 변경
                </button>
            </form>
            
            <div class="loading" id="loading">
                비밀번호를 변경하는 중...
            </div>
            
            <div class="error" id="error"></div>
            <div class="success" id="success">
                비밀번호가 변경되었습니다.
            </div>
        </div>
    </div>

    <script>
        // 서버 API URL (현재 페이지의 호스트 사용)
        const API_BASE_URL = window.location.origin;
        
        // Supabase 설정 (세션 확인용)
        const SUPABASE_URL = 'https://qgtwkhkmdsaypnsnrpbf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFndHdraGttZHNheXBuc25ycGJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0OTU1MzAsImV4cCI6MjA4MzA3MTUzMH0.mE1BGCOCMNza2ixbC-lrVXRdCmmL5n_YCPaMcqy-mcs';
        
        // Supabase 클라이언트 생성 (전역 변수 충돌 방지)
        let supabaseClient;
        if (typeof window.supabase !== 'undefined') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error('Supabase 라이브러리를 찾을 수 없습니다.');
        }
        
        // 비밀번호 표시/숨김 토글
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
            }
        }
        
        // 비밀번호 요구사항 확인
        function checkPasswordRequirements(password) {
            return {
                minLength: password.length >= 8,
                hasUpperCase: /(?=.*[A-Z])/.test(password),
                hasLowerCase: /(?=.*[a-z])/.test(password),
                hasNumber: /(?=.*[0-9])/.test(password),
                hasSpecialChar: /(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?])/.test(password),
            };
        }
        
        // 비밀번호 요구사항 UI 업데이트
        function updatePasswordRequirements(password) {
            const requirements = checkPasswordRequirements(password);
            const requirementsDiv = document.getElementById('passwordRequirements');
            
            if (!requirementsDiv) {
                console.error('passwordRequirements 요소를 찾을 수 없습니다.');
                return;
            }
            
            if (password.length > 0) {
                requirementsDiv.style.display = 'block';
                requirementsDiv.style.visibility = 'visible';
            } else {
                requirementsDiv.style.display = 'none';
                requirementsDiv.style.visibility = 'hidden';
            }
            
            // 각 요구사항 아이콘 업데이트
            const items = [
                { id: 'reqMinLength', valid: requirements.minLength },
                { id: 'reqUpperCase', valid: requirements.hasUpperCase },
                { id: 'reqLowerCase', valid: requirements.hasLowerCase },
                { id: 'reqNumber', valid: requirements.hasNumber },
                { id: 'reqSpecialChar', valid: requirements.hasSpecialChar },
            ];
            
            items.forEach(item => {
                const icon = document.getElementById(item.id);
                const text = document.getElementById(item.id + 'Text');
                
                if (item.valid) {
                    icon.classList.remove('invalid');
                    icon.classList.add('valid');
                    icon.innerHTML = '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>';
                    text.classList.remove('invalid');
                    text.classList.add('valid');
                    icon.style.color = '#10b981';
                    text.style.color = '#10b981';
                } else {
                    icon.classList.remove('valid');
                    icon.classList.add('invalid');
                    icon.innerHTML = '<circle cx="12" cy="12" r="10"></circle>';
                    text.classList.remove('valid');
                    text.classList.add('invalid');
                    icon.style.color = '#9ca3af';
                    text.style.color = '#6b7280';
                }
            });
        }
        
        // 비밀번호 일치 확인
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchDiv = document.getElementById('passwordMatch');
            const wrapper = document.getElementById('confirmPasswordWrapper');
            
            if (confirmPassword.length === 0) {
                matchDiv.style.display = 'none';
                wrapper.classList.remove('valid', 'invalid');
                wrapper.style.borderColor = '#d1d5db';
                return false;
            }
            
            matchDiv.style.display = 'block';
            
            if (newPassword && newPassword === confirmPassword) {
                matchDiv.classList.remove('invalid');
                matchDiv.classList.add('valid');
                matchDiv.textContent = '비밀번호가 일치합니다.';
                wrapper.classList.remove('invalid');
                wrapper.classList.add('valid');
                wrapper.style.borderColor = '#10b981';
                return true;
            } else if (confirmPassword && newPassword !== confirmPassword) {
                matchDiv.classList.remove('valid');
                matchDiv.classList.add('invalid');
                matchDiv.textContent = '비밀번호가 일치하지 않습니다.';
                wrapper.classList.remove('valid');
                wrapper.classList.add('invalid');
                wrapper.style.borderColor = '#ef4444';
                return false;
            } else {
                wrapper.style.borderColor = '#d1d5db';
                return false;
            }
        }
        
        // URL에서 토큰 파싱 및 세션 설정
        async function setupSession() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const hash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hash);
                
                // query string에서 토큰 찾기
                let accessToken = urlParams.get('access_token');
                let refreshToken = urlParams.get('refresh_token');
                let type = urlParams.get('type');
                
                // hash에서 토큰 찾기 (우선순위)
                if (hashParams.get('access_token')) {
                    accessToken = hashParams.get('access_token');
                    refreshToken = hashParams.get('refresh_token');
                    type = hashParams.get('type');
                }
                
                if (accessToken && refreshToken && type === 'recovery') {
                    // 토큰으로 세션 설정
                    const { data, error } = await supabaseClient.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    
                    if (error) {
                        throw error;
                    }
                    
                    // 사용자 이메일 가져오기
                    if (data.session && data.user) {
                        displayUserEmail(data.user.email);
                        return true;
                    }
                    
                    return true;
                }
                
                // 기존 세션 확인
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session && session.user) {
                    displayUserEmail(session.user.email);
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('세션 설정 실패:', error);
                return false;
            }
        }
        
        // 사용자 이메일 표시
        function displayUserEmail(email) {
            const userEmailInput = document.getElementById('userEmail');
            
            if (email && userEmailInput) {
                userEmailInput.value = email;
            }
        }
        
        // 비밀번호 재설정 처리
        async function handleResetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const userEmail = document.getElementById('userEmail').value;
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            
            // 에러 및 성공 메시지 초기화
            error.classList.remove('active');
            success.classList.remove('active');
            
            // 유효성 검사
            if (!userEmail) {
                error.textContent = '이메일을 찾을 수 없습니다. 링크가 유효하지 않을 수 있습니다.';
                error.classList.add('active');
                return;
            }
            
            if (!newPassword || !confirmPassword) {
                error.textContent = '모든 필드를 입력해주세요.';
                error.classList.add('active');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                error.textContent = '새 비밀번호와 확인 비밀번호가 일치하지 않습니다.';
                error.classList.add('active');
                return;
            }
            
            const requirements = checkPasswordRequirements(newPassword);
            if (!requirements.minLength) {
                error.textContent = '비밀번호는 최소 8자 이상이어야 합니다.';
                error.classList.add('active');
                return;
            }
            if (!requirements.hasUpperCase || !requirements.hasLowerCase) {
                error.textContent = '비밀번호는 대문자와 소문자를 포함해야 합니다.';
                error.classList.add('active');
                return;
            }
            if (!requirements.hasNumber) {
                error.textContent = '비밀번호는 숫자를 포함해야 합니다.';
                error.classList.add('active');
                return;
            }
            if (!requirements.hasSpecialChar) {
                error.textContent = '비밀번호는 특수문자를 포함해야 합니다.';
                error.classList.add('active');
                return;
            }
            
            // 로딩 시작
            submitBtn.disabled = true;
            loading.classList.add('active');
            
            try {
                // 서버 API로 비밀번호 업데이트
                const response = await fetch(`${API_BASE_URL}/api/auth/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: userEmail,
                        newPassword: newPassword.trim()
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || '비밀번호 변경에 실패했습니다.');
                }
                
                // 성공
                loading.classList.remove('active');
                success.classList.add('active');
                
                // 3초 후 앱으로 리다이렉트 시도 (실패해도 무시)
                setTimeout(() => {
                    try {
                        // 앱 딥링크 시도
                        window.location.href = 'thedongmunhoi://login';
                    } catch (err) {
                        // 딥링크 실패 시 무시 (웹 브라우저에서는 정상)
                        console.log('앱 딥링크는 앱에서만 작동합니다. 앱으로 돌아가서 로그인해주세요.');
                    }
                }, 3000);
                
            } catch (err) {
                console.error('비밀번호 재설정 실패:', err);
                loading.classList.remove('active');
                const errorDiv = document.getElementById('error');
                if (errorDiv) {
                    errorDiv.textContent = err.message || '비밀번호 변경 중 오류가 발생했습니다.';
                    errorDiv.classList.add('active');
                }
                submitBtn.disabled = false;
            }
        }
        
        // 이벤트 리스너 설정
        function setupEventListeners() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    updatePasswordRequirements(value);
                    checkPasswordMatch();
                });
                // keyup 이벤트도 추가 (더 확실하게)
                newPasswordInput.addEventListener('keyup', function(e) {
                    const value = e.target.value;
                    updatePasswordRequirements(value);
                    checkPasswordMatch();
                });
            } else {
                console.error('newPassword 입력 필드를 찾을 수 없습니다.');
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', function() {
                    checkPasswordMatch();
                });
            }
        }
        
        // 페이지 로드 시 초기화
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                setupSession();
            });
        } else {
            // DOM이 이미 로드된 경우
            setupEventListeners();
            setupSession();
        }
    </script>
</body>
</html>

